Index: AppleADBMouse.cpp
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/AppleADBMouse.cpp,v
retrieving revision 1.7
retrieving revision 1.7.4.1
diff -u -d -b -w -r1.7 -r1.7.4.1
--- AppleADBMouse.cpp	2002/10/18 03:03:47	1.7
+++ AppleADBMouse.cpp	2003/01/11 04:43:17	1.7.4.1
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 1998-2002 Apple Computer, Inc. All rights reserved.
+ * Copyright (c) 1998-2003 Apple Computer, Inc. All rights reserved.
  *
  * @APPLE_LICENSE_HEADER_START@
  * 
@@ -279,6 +279,8 @@
 
   _buttonCount = deviceNumButtons;
   _notifierA = _notifierT = NULL;  //Only used by trackpad, but inspected by all type 4 mice
+  _gettime = OSSymbol::withCString("get_last_keydown");
+  _mouseLock = IOLockAlloc(); 
 
   adbDevice->readRegister(1, adbdata, &adblength);
   if( (adbdata[0] == 't') && (adbdata[1] = 'p') && (adbdata[2] == 'a') && (adbdata[3] == 'd') )
@@ -332,6 +334,23 @@
 	_notifierT = NULL;
     }
     _ignoreTrackpad = false;
+    
+    if (_gettime)
+	_gettime->release();
+    
+    if (_mouseLock)
+    {
+	IOLock * lock;
+
+	IOLockLock(_mouseLock);
+
+	lock = _mouseLock;
+	_mouseLock = NULL;
+
+	IOLockUnlock(lock);
+	IOLockFree(lock);
+    }
+
     super::free();
 }
 
@@ -429,14 +448,12 @@
     {
 	if ((_jitterclick) && (_pADBKeyboard))
 	{
-	    const OSSymbol 	*gettime;
 	    AbsoluteTime	keyboardtime; 
 	    UInt64		nowtime64, keytime64;
 
-	    gettime = OSSymbol::withCString("get_last_keydown");
 	    keyboardtime.hi = 0;
 	    keyboardtime.lo = 0;
-	    _pADBKeyboard->callPlatformFunction(gettime, false, 
+	    _pADBKeyboard->callPlatformFunction(_gettime, false, 
 		(void *)&keyboardtime, 0, 0, 0);
 	    clock_get_uptime(&now);
 	    absolutetime_to_nanoseconds(now, &nowtime64);
@@ -477,14 +494,12 @@
 	{
 	    if (_pADBKeyboard)
 	    {
-		const OSSymbol 	*gettime;
 		AbsoluteTime	keyboardtime; 
 		UInt64		nowtime64, keytime64;
 
-		gettime = OSSymbol::withCString("get_last_keydown");
 		keyboardtime.hi = 0;
 		keyboardtime.lo = 0;
-		_pADBKeyboard->callPlatformFunction(gettime, false, (void *)&keyboardtime, 0, 0, 0);
+		_pADBKeyboard->callPlatformFunction(_gettime, false, (void *)&keyboardtime, 0, 0, 0);
 		absolutetime_to_nanoseconds(now, &nowtime64);
 		absolutetime_to_nanoseconds(keyboardtime, &keytime64);
 		if (nowtime64 - keytime64 < _jitterclicktime64)
@@ -520,8 +535,12 @@
     keyName[7] = (deviceSignature >> 0);
     keyName[8] = 0;
 
+    IOLockLock( _mouseLock);
+    
     OSData * data = OSDynamicCast( OSData,
                 getProperty( keyName ));
+    IOLockUnlock( _mouseLock);
+    
     if( data)
     {
         data->retain();
@@ -623,6 +642,7 @@
     UInt8       adbdata[8];
     IOByteCount adblength;
     
+    IOLockLock (_mouseLock);
     if( (data = OSDynamicCast(OSData, dict->getObject("Clicking"))) && (typeTrackpad == TRUE) )
     {
         adblength = sizeof(adbdata);
@@ -723,6 +743,8 @@
     IOLog("adbdata[7] = 0x%x\n", adbdata[7]);
 #endif
 
+    IOLockUnlock( _mouseLock);
+    
     if (err == kIOReturnSuccess)
     {
         return super::setParamProperties(dict);
Index: AppleADBMouse.h
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/AppleADBMouse.h,v
retrieving revision 1.5
retrieving revision 1.5.4.1
diff -u -d -b -w -r1.5 -r1.5.4.1
--- AppleADBMouse.h	2002/07/02 03:40:38	1.5
+++ AppleADBMouse.h	2003/01/11 04:43:17	1.5.4.1
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 1998-2002 Apple Computer, Inc. All rights reserved.
+ * Copyright (c) 1998-2003 Apple Computer, Inc. All rights reserved.
  *
  * @APPLE_LICENSE_HEADER_START@
  * 
@@ -85,6 +85,8 @@
     bool enableEnhancedMode();
     IOService *_pADBKeyboard;
     IONotifier * _notifierA, * _notifierT;
+    const OSSymbol 	*_gettime;
+    IOLock *		_mouseLock;  
 
 protected:
   UInt32 deviceSignature;
Index: AppleADBMouse.pbproj/project.pbxproj
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/AppleADBMouse.pbproj/project.pbxproj,v
retrieving revision 1.11
retrieving revision 1.11.4.2
diff -u -d -b -w -r1.11 -r1.11.4.2
--- project.pbxproj	2002/10/18 03:03:48	1.11
+++ project.pbxproj	2003/01/11 04:56:55	1.11.4.2
@@ -100,7 +100,7 @@
 				LIBRARY_SEARCH_PATHS = "";
 				MODULE_IOKIT = YES;
 				MODULE_NAME = com.apple.driver.AppleADBMouse;
-				MODULE_VERSION = 2.0.5d3;
+				MODULE_VERSION = 2.0.7d1;
 				OTHER_CFLAGS = "";
 				OTHER_LDFLAGS = "";
 				OTHER_REZFLAGS = "";
@@ -135,11 +135,11 @@
 	<key>CFBundlePackageType</key>
 	<string>KEXT</string>
 	<key>CFBundleShortVersionString</key>
-	<string>2.0.5</string>
+	<string>2.0.7</string>
 	<key>CFBundleSignature</key>
 	<string>????</string>
 	<key>CFBundleVersion</key>
-	<string>2.0.5d3</string>
+	<string>2.0.7d1</string>
 	<key>IOKitPersonalities</key>
 	<dict>
 		<key>AppleADBMouseType1</key>
Index: English.lproj/InfoPlist.strings
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/English.lproj/InfoPlist.strings,v
retrieving revision 1.6
retrieving revision 1.6.4.2
diff -u -d -b -w -r1.6 -r1.6.4.2
Binary files /tmp/cvs015997 and /tmp/cvsa15997 differ
Index: pbxbuild.data/AppleADBMouse.build/Info.plist
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/pbxbuild.data/AppleADBMouse.build/Info.plist,v
retrieving revision 1.5
retrieving revision 1.5.4.2
diff -u -d -b -w -r1.5 -r1.5.4.2
--- Info.plist	2002/10/18 03:03:49	1.5
+++ Info.plist	2003/01/11 04:56:56	1.5.4.2
@@ -15,11 +15,11 @@
 	<key>CFBundlePackageType</key>
 	<string>KEXT</string>
 	<key>CFBundleShortVersionString</key>
-	<string>2.0.5</string>
+	<string>2.0.7</string>
 	<key>CFBundleSignature</key>
 	<string>????</string>
 	<key>CFBundleVersion</key>
-	<string>2.0.5d3</string>
+	<string>2.0.7d1</string>
 	<key>IOKitPersonalities</key>
 	<dict>
 		<key>AppleADBMouseType1</key>
Index: pbxbuild.data/AppleADBMouse.build/Jamfile.jam
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/pbxbuild.data/AppleADBMouse.build/Jamfile.jam,v
retrieving revision 1.5
retrieving revision 1.5.4.2
diff -u -d -b -w -r1.5 -r1.5.4.2
--- Jamfile.jam	2002/10/18 03:03:49	1.5
+++ Jamfile.jam	2003/01/11 04:56:56	1.5.4.2
@@ -7,7 +7,7 @@
 export deferred DEVELOPMENT_LANGUAGE = English ;
 export deferred PROJECT = $(PROJECT_NAME) ;
 export deferred PROJECT_NAME = AppleADBMouse ;
-export deferred SRCROOT = /Network/Servers/abel/homes/gimli/adam.w/projects/usbfix2/AppleADBMouse ;
+export deferred SRCROOT = /Volumes/OS9-7gig/FromYosemite/sources/projects/objectoverflow/AppleADBMouse ;
 
 # User-defined project-wide settings for project
 
@@ -31,7 +31,7 @@
 export deferred LIBRARY_SEARCH_PATHS =  ;
 export deferred MODULE_IOKIT = YES ;
 export deferred MODULE_NAME = com.apple.driver.AppleADBMouse ;
-export deferred MODULE_VERSION = 2.0.5d3 ;
+export deferred MODULE_VERSION = 2.0.7d1 ;
 export deferred OTHER_CFLAGS =  ;
 export deferred OTHER_LDFLAGS =  ;
 export deferred OTHER_REZFLAGS =  ;
Index: pbxbuild.data/AppleADBMouse.build/pbdevelopment.plist
===================================================================
RCS file: /cvs/Darwin/src/live/AppleADBMouse/pbxbuild.data/AppleADBMouse.build/pbdevelopment.plist,v
retrieving revision 1.4
retrieving revision 1.4.4.1
diff -u -d -b -w -r1.4 -r1.4.4.1
--- pbdevelopment.plist	2002/10/18 03:03:49	1.4
+++ pbdevelopment.plist	2003/01/11 04:43:18	1.4.4.1
@@ -3,6 +3,6 @@
 <plist version="1.0">
 <dict>
 	<key>PBXProjectSourcePath</key>
-	<string>/Network/Servers/abel/homes/gimli/adam.w/projects/usbfix2/AppleADBMouse/AppleADBMouse.pbproj</string>
+	<string>/Volumes/OS9-7gig/FromYosemite/sources/projects/objectoverflow/AppleADBMouse/AppleADBMouse.pbproj</string>
 </dict>
 </plist>
